<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Meta AR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.5/aframe/build/aframe-ar.min.js"></script>
<script src="/socket.io/socket.io.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  background: black;
}
#loading {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-family: sans-serif;
}
#hud {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,.6);
  color: #fff;
  padding: 8px;
  font-size: 14px;
  z-index: 10;
}
#actions {
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;
}
button {
  padding: 10px;
}
</style>
</head>

<body>

<div id="loading">üì° Obtendo localiza√ß√£o...</div>

<div id="hud" style="display:none">
  <div id="score">Score: 0</div>
</div>

<div id="actions" style="display:none">
  <button id="noteBtn">üìù Anotar</button>
</div>

<script>
const socket = io();
let scene, camera;
let myPos = null;
let score = 0;
const entities = {};
const name = prompt("Seu nome?") || "Anon";

// 1Ô∏è‚É£ PEDE GPS PRIMEIRO
navigator.geolocation.getCurrentPosition(pos => {
  myPos = pos.coords;
  startAR();
}, err => {
  alert("GPS √© obrigat√≥rio para o Meta AR");
}, { enableHighAccuracy: true });

// 2Ô∏è‚É£ INICIALIZA AR DEPOIS DO GPS
function startAR() {
  document.getElementById("loading").remove();
  document.getElementById("hud").style.display = "block";
  document.getElementById("actions").style.display = "block";

  scene = document.createElement("a-scene");
  scene.setAttribute("embedded", "");
  scene.setAttribute("vr-mode-ui", "enabled:false");
  scene.setAttribute("arjs", "sourceType: webcam; debugUIEnabled: false;");

  camera = document.createElement("a-entity");
  camera.setAttribute("camera", "");
  camera.setAttribute("gps-camera", "");
  camera.setAttribute("rotation-reader", "");

  scene.appendChild(camera);
  document.body.appendChild(scene);

  socket.emit("join", {
    name,
    lat: myPos.latitude,
    lng: myPos.longitude
  });

  navigator.geolocation.watchPosition(p => {
    myPos = p.coords;
    socket.emit("move", {
      lat: myPos.latitude,
      lng: myPos.longitude
    });
  }, null, { enableHighAccuracy: true });
}

// 3Ô∏è‚É£ SPAWN VISUAL
function spawn(id, lat, lng, color, label) {
  if (entities[id]) return;
  const e = document.createElement("a-entity");
  e.setAttribute("gps-entity-place", `latitude:${lat}; longitude:${lng}`);
  e.setAttribute("geometry", "primitive:sphere; radius:1");
  e.setAttribute("material", `color:${color}`);
  if (label) {
    const t = document.createElement("a-text");
    t.setAttribute("value", label);
    t.setAttribute("position", "0 2 0");
    t.setAttribute("scale", "3 3 3");
    e.appendChild(t);
  }
  scene.appendChild(e);
  entities[id] = e;
}

// 4Ô∏è‚É£ SOCKET EVENTS
socket.on("world_init", world => {
  Object.values(world.orbs).forEach(o =>
    spawn(o.id, o.lat, o.lng, "cyan", "ORB")
  );
  world.objects.forEach(o =>
    spawn(o.id, o.lat, o.lng, "purple", o.text + "\n@" + o.author)
  );
});

socket.on("orb_collected", data => {
  if (entities[data.orbId]) {
    scene.removeChild(entities[data.orbId]);
    delete entities[data.orbId];
  }
  if (data.player.name === name) {
    score = data.player.score;
    document.getElementById("score").innerText = "Score: " + score;
  }
});

socket.on("object_created", obj =>
  spawn(obj.id, obj.lat, obj.lng, "purple", obj.text + "\n@" + obj.author)
);

// 5Ô∏è‚É£ CRIAR ANOTA√á√ÉO
document.getElementById("noteBtn").onclick = () => {
  if (!myPos) return;
  const text = prompt("Anota√ß√£o:");
  if (!text) return;
  socket.emit("create_object", {
    lat: myPos.latitude,
    lng: myPos.longitude,
    text
  });
};
</script>

</body>
</html>
